<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at Mar 6, 2013
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Steven Swor" />
    <meta name="Date-Creation-yyyymmdd" content="20121220" />
    <meta name="Date-Revision-yyyymmdd" content="20130306" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Ehcache File Monitor - Tutorial - Resource Caching</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarEnabled">
          
                        
                    
                

    <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
                                  <div class="container"><div class="nav-collapse">
            
                
                                <ul class="nav">
                          <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Overview <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="index.html"  title="About">About</a>
</li>
                  
                      <li>      <a href="resource-caching.html"  title="Resource Caching">Resource Caching</a>
</li>
                  
                      <li>      <a href="performance-tuning.html"  title="Performance Tuning">Performance Tuning</a>
</li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Project Documentation <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li class="dropdown-submenu">
                                      <a href="project-info.html"  title="Project Information">Project Information</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="project-summary.html"  title="Project Summary">Project Summary</a>
</li>
                                  <li>      <a href="dependency-info.html"  title="Dependency Information">Dependency Information</a>
</li>
                                  <li>      <a href="dependencies.html"  title="Dependencies">Dependencies</a>
</li>
                                  <li>      <a href="issue-tracking.html"  title="Issue Tracking">Issue Tracking</a>
</li>
                                  <li>      <a href="source-repository.html"  title="Source Repository">Source Repository</a>
</li>
                                  <li>      <a href="team-list.html"  title="Project Team">Project Team</a>
</li>
                                  <li>      <a href="distribution-management.html"  title="Distribution Management">Distribution Management</a>
</li>
                                  <li>      <a href="plugins.html"  title="Project Plugins">Project Plugins</a>
</li>
                                  <li>      <a href="license.html"  title="Project License">Project License</a>
</li>
                              </ul>
            </li>
                  
                      <li class="dropdown-submenu">
                                      <a href="project-reports.html"  title="Project Reports">Project Reports</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="apidocs/index.html"  title="JavaDocs">JavaDocs</a>
</li>
                                  <li>      <a href="testapidocs/index.html"  title="Test JavaDocs">Test JavaDocs</a>
</li>
                                  <li>      <a href="xref/index.html"  title="Source Xref">Source Xref</a>
</li>
                                  <li>      <a href="xref-test/index.html"  title="Test Source Xref">Test Source Xref</a>
</li>
                                  <li>      <a href="pmd.html"  title="PMD Report">PMD Report</a>
</li>
                                  <li>      <a href="cpd.html"  title="CPD Report">CPD Report</a>
</li>
                                  <li>      <a href="findbugs.html"  title="FindBugs Report">FindBugs Report</a>
</li>
                              </ul>
            </li>
                          </ul>
      </li>
                  </ul>
          
          
                                                              
                               <ul class="nav pull-right">
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">External Links <b class="caret"></b></a>
                <ul class="dropdown-menu">
                      <li>      <a href="http://www.ehcache.org/"  target="_blank" title="Ehcache">Ehcache</a>
</li>
      <li>      <a href="https://sworisbreathing.github.com/sfmf4j/"  target="_blank" title="SFMF4J">SFMF4J</a>
</li>
                  </ul>
              </li>
            </ul>
          
                      </div>
          
        </div>
      </div>
    </div>
    
        <div class="container">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Ehcache File Monitor</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                              <li class="">
                    <a href="index.html" title="Ehcache File Monitor">
        Ehcache File Monitor</a>
        </li>
      <li class="divider ">/</li>
        <li class="">Tutorial - Resource Caching</li>
        
                
                    
                 <li id="projectVersion" class="pull-right">Version: 1.0-SNAPSHOT</li>
      
                            </ul>
      </div>

      
                
        <div id="bodyColumn" >
                                  
            <!--  --><!-- Copyright 2013 Steven Swor. --><!--  --><!-- Licensed under the Apache License, Version 2.0 (the "License"); --><!-- you may not use this file except in compliance with the License. --><!-- You may obtain a copy of the License at --><!--  --><!-- http://www.apache.org/licenses/LICENSE-2.0 --><!--  --><!-- Unless required by applicable law or agreed to in writing, software --><!-- distributed under the License is distributed on an "AS IS" BASIS, --><!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. --><!-- See the License for the specific language governing permissions and --><!-- limitations under the License. --><!--  --><div class="section"><h2>Resource Caching Example<a name="Resource_Caching_Example"></a></h2><p>This example is based on how resource caching is configured in the application for which Ehcache File Monitor was originally developed. This was a web application installed into a Jetty container. Certain business functions were loaded from Groovy scripts stored in <tt>$JETTY_HOME/resources</tt>. Ehcache File Monitor was developed to:</p><ul><li>allow hot deployment of modifications to resource files</li><li>ensure that modifications to resource files were reflected immediately in the application</li><li>minimize the amount of I/O operations</li></ul><div class="section"><h3>Ehcache Configuration<a name="Ehcache_Configuration"></a></h3><p>Ehcache is configured via an <tt>ehcache.xml</tt> in the root of the classpath. In a Jetty deployment environment, this file is located in <tt>$JETTY_HOME/resources</tt>. For our purposes, we are only interested in minimizing the amount of I/O involved in loading resources from a file system, so we don't need most of Ehcache's advanced features.</p><div class="source"><pre class="prettyprint">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!--
    Don't check for new ehcache versions.
    Limit the cache size to 30% of the JVM's heap size.
--&gt;
&lt;ehcache updateCheck=&quot;false&quot;
         maxBytesLocalHeap=&quot;30%&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:noNamespaceSchemaLocation=&quot;ehcache.xsd&quot;&gt;
    &lt;!--
      Objects expire if they haven't been requested in 10 minutes.
    --&gt;
    &lt;defaultCache timeToIdleSeconds=&quot;600&quot;&gt;
        &lt;!--
          Don't persist the cache across JVM restarts.
        --&gt;
        &lt;persistence strategy=&quot;none&quot; /&gt;
    &lt;/cache&gt;
&lt;/ehcache&gt;
</pre></div></div><div class="section"><h3>Limiting SizeOf Calculations<a name="Limiting_SizeOf_Calculations"></a></h3><p>In this example, we have limited the size of our cache based on the amount of memory consumed (as opposed to limiting it based on the number of objects in the cache). Ehcache's algorithm for calculating memory usage traverses the object graph for each item in the cache. This can result in a performance penalty if the object graph is very large (Ehcache actually warns you in its log output when this happens).</p><p>To limit the scope of the <tt>sizeOf</tt> algorithm, we can configure Ehcache to filter out Groovy's internal classes, since these tend to result in very large object graphs. We put this in a file named <tt>ehcachesizeof.filter</tt> in the root of the class path (i.e. <tt>$JETTY_HOME/resources</tt>):</p><div class="source"><pre class="prettyprint"># This file defines the package, class, and field names which should be ignored
# by Ehcache when it tries to calculate the size of elements in the cache.
#
# Ehcache doesn't like big object graphs because it causes a performance penalty
# when computing the memory footprint for an object.  With this file, we can
# limit how far Ehcache will traverse an object graph when computing the size
# of a cached object.
#
# NOTE: package declarations in this file are not hierarchical.  In other words,
# specifying package foo.bar in this file will ignore class foo.bar.Baz but not
# class foo.bar.xxx.Baz
#
# See http://ehcache.org/documentation/configuration/cache-size

# Ignore Groovy's internal classes
org.codehaus.groovy
groovy.lang
</pre></div></div><div class="section"><h3>GroovyObjectFileLoadingCacheEntryFactory<a name="GroovyObjectFileLoadingCacheEntryFactory"></a></h3><p>In this particular example, we are caching objects loaded from Groovy scripts on the file system. The <tt>GroovyObjectFileLoadingCacheEntryFactory</tt> is responsible for loading and compiling the scripts, as well as obtaining object instances from the compiled Groovy classes.</p><div class="source"><pre class="prettyprint">import com.github.sworisbreathing.ehcachefilemonitor.FileLoadingCacheEntryFactory;
import groovy.lang.GroovyClassLoader;
import groovy.lang.GroovyCodeSource;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.InputStreamReader;
import java.io.Reader;

public class GroovyObjectFileLoadingCacheEntryFactory extends FileLoadingCacheEntryFactory {

    @Override
    protected Object loadObjectFromFile(File file) throws Exception {
        Class clazz = loadClassFromFile(file);
        return clazz.newInstance();
    }

    protected static &lt;T&gt; Class&lt;T&gt; loadClassFromFile(final File file) throws FileNotFoundException {
      try(
            InputStream stream = new FileInputStream(file);
            Reader reader = new InputStreamReader(stream);
        ){
            ClassLoader parent = GroovyObjectFileLoadingCacheEntryFactory.class.getClassLoader();
            GroovyClassLoader groovyClassLoader = new GroovyClassLoader(parent);
            GroovyCodeSource codeSource = new GroovyCodeSource(reader, file.getName(), file.getPath());
            codeSource.setCachable(true);
            Class&lt;T&gt; implementingClass = groovyClassLoader.parseClass(codeSource);
            return implementingClass;
      }
    }
}
</pre></div></div><div class="section"><h3>Application Initialization<a name="Application_Initialization"></a></h3><p>Our application has a few tasks which must be performed once, and only once, when it first launches:</p><ul><li><a href="#Configure_Ehcache_SizeOf_Filtering">Configure Ehcache SizeOf Filtering</a></li><li><a href="#Decorate_The_Groovy_Script_Cache">Decorate the Groovy script cache with a <tt>SelfPopulatingCache</tt></a></li><li><a href="#File_Monitoring">Start a timer to monitor the file system</a></li><li><a href="#Register_A_FileMonitoringEventListener">Register a <tt>FileMonitoringCacheEventListener</tt> with the cache</a></li><li><a href="#Eagerly_Evicting_Expired_Items">Start a timer to eagerly evict expired elements from the cache</a></li></ul><div class="section"><h4>Configure Ehcache SizeOf Filtering<a name="Configure_Ehcache_SizeOf_Filtering"></a></h4><p><a href="#Limiting_SizeOf_Calculations">As previously mentioned</a>, we want to limit the scope of Ehcache's SizeOf algorithm with a filtering file. When Ehcache starts up, it looks for the system property <tt>net.sf.ehcache.sizeof.filter</tt>, whose value is the path to the filtering file. We can specify the system property as a JVM argument, or do it programmatically (prior to the first call to <tt>CacheManager.getInstance()</tt>):</p><div class="source"><pre class="prettyprint">/*
 * Set the name of the sizeof filter file.  This will prevent ehcache
 * warnings about object graphs being too large when it tries to
 * calculate the cache size.
 */
System.setProperty(&quot;net.sf.ehcache.sizeof.filter&quot;, &quot;ehcachesizeof.filter&quot;);
</pre></div></div><div class="section"><h4>Decorate The Groovy Script Cache<a name="Decorate_The_Groovy_Script_Cache"></a></h4><p>We have a cache defined in <a href="#Ehcache_Configuration">ehcache.xml</a> from which we can obtain object instances loaded from Groovy scripts. However, for all their fancy housekeeping algorithms, caches are merely object repositories. There must be some code, somewhere, which puts stuff into the cache.</p><p>We want to make our caching solution as seamless and transparent as possible. The calling code shouldn't have to take any special action if items are not in the cache (or if the items in the cache are no longer valid).</p><p>Thankfully, Ehcache provides a solution. <tt>SelfPopulatingCache</tt> follows the <a class="externalLink" href="http://en.wikipedia.org/wiki/Decorator_pattern">decorator pattern</a>, wrapping an underlying cache implementation. When items are requested which are not in the cache (or have expired), the wrapper transparently adds a new entry for the item, created by a <tt>CacheEntryFactory</tt>.</p><p>This bit of code decorates the script cache from <tt>ehcache.xml</tt> with a <tt>SelfPopulatingCache</tt> which will load objects using our <a href="#GroovyObjectFileLoadingCacheEntryFactory">GroovyObjectFileLoadingCacheEntryFactory</a>:</p><div class="source"><pre class="prettyprint">/*
 * Replace the groovy script cache defined in ehcache.xml with one that
 * will lazy-load objects from their script files.
 */
CacheManager defaultCacheManager = CacheManager.getInstance();
Ehcache scriptCache = defaultCacheManager.getEhcache(&quot;GroovyScripts&quot;);
SelfPopulatingCache selfPopulatingScriptCache = new SelfPopulatingCache(scriptCache, new GroovyObjectFileLoadingCacheEntryFactory());
defaultCacheManager.replaceCacheWithDecoratedCache(scriptCache, selfPopulatingScriptCache);
</pre></div></div><div class="section"><h4>File Monitoring<a name="File_Monitoring"></a></h4><p>Caching scripts reduces disk I/O by only reading from the file system when there isn't a valid entry in the cache. When someone edits the script with updated business logic, we know the new logic should <i>eventually</i> be loaded into the application. The <tt>timeToIdleSeconds</tt> setting in <a href="#Ehcache_Configuration">ehcache.xml</a> ensures that scripts will expire after they have sat in the cache for 10 minutes without being requested. But how can we ensure that the new logic will be loaded if our users are constantly performing tasks which request scripts from the cache?</p><p>To ensure the &quot;freshness&quot; of the business logic in a constant-demand scenario (where a consistent influx of user requests prevents cache entries from expiring), we can use a file monitoring solution which removes an entry from the cache when it detects a change to the associated script file.</p><div class="source"><pre class="prettyprint">/*
 * Start the file monitor, which will detect changes to our scripts.
 *
 * Note: This requires an SFMF4J implementation on the class path.
 * Consider setting this up through an IoC container, such as Spring, instead.
 */
fileMonitorService = loadFileMonitorServiceFactory().createFileMonitorService();
fileMonitorService.initialize();
</pre></div><p>Ehcache File Monitor uses <a class="externalLink" href="https://sworisbreathing.github.com/sfmf4j">SFMF4J</a> for file system monitoring. Your application must have an SFMF4J implementation on the class path in order to obtain an instance of <tt>FileMonitorServiceFactory</tt>.</p></div><div class="section"><h4>Register A FileMonitoringEventListener<a name="Register_A_FileMonitoringEventListener"></a></h4><p>Now that our cache is decorated and the file system monitor is up and running, we can bridge the two together, so that cache entries will be removed when changes are detected to their underlying script files.</p><div class="source"><pre class="prettyprint">/*
 * Add a listener which will automatically remove an object from the
 * cache when its script file changes, and will stop monitoring for
 * script changes when an object is removed, expired, or evicted from
 * the cache.
 */
cacheListener = new FileMonitoringCacheEventListener(selfPopulatingScriptCache, fileMonitorService);
selfPopulatingScriptCache.getCacheEventNotificationService().registerListener(cacheListener);
</pre></div></div><div class="section"><h4>Eagerly Evicting Expired Items<a name="Eagerly_Evicting_Expired_Items"></a></h4><p>Ehcache lazily checks cache entries for expiration and notifies interested parties (e.g. when application code retrieves items from the cache). This is generally a good idea, since most of the time, it's not a big deal to have a bit of stale data in the cache if nothing can access it. However, our solution uses cache notification to manage file system notifications.</p><p>As long as an expired item sits in the cache without the <tt>FileMonitoringCacheEventListener</tt> being made aware of its expiration, we will keep monitoring the file system for changes to that file. If our file system monitoring solution uses polling, this can result in unnecessary I/O, since it is guaranteed that, once an item expires, the script will be loaded from the file system the next time it is requested from the cache.</p><p>To reduce the amount of unnecessary I/O, we can periodically ask Ehcache to evict expired items:</p><div class="source"><pre class="prettyprint">/*
 * By default, Ehcache waits until the next &quot;get&quot; call before checking
 * for expiration.  However, as long as a file is in the cache, the file
 * monitor could poll the file system looking for changes to that file, even
 * if the entry has expired (i.e. the next &quot;get&quot; call will cause us to load
 * the script file again).
 *
 * To prevent unnecessary file polling in this case, we start a timer
 * here to periodically ask the cache to evict expired elements.
 */
ehcacheExpirationMonitorService = Executors.newSingleThreadScheduledExecutor(new ThreadFactory() {
   @Override
   public Thread newThread(Runnable r) {
       return new Thread(r, &quot;Ehcache Expiration Monitor&quot;);
   }
});
ehcacheExpirationMonitorService.scheduleWithFixedDelay(new Runnable() {
   @Override
   public void run() {
       Ehcache scriptCache = CacheManager.getInstance().getEhcache(&quot;GroovyScripts&quot;);
       scriptCache.evictExpiredElements();
   }
}, 0, CACHE_EXPIRATION_MINUTES, TimeUnit.MINUTES);
</pre></div></div><div class="section"><h4>Putting It All Together<a name="Putting_It_All_Together"></a></h4><p>Here is an example which sets everything up in a single method call.</p><div class="source"><pre class="prettyprint">long CACHE_EXPIRATION_MINUTES = //...

/**
 * Loads a file monitor service implementation using Java SPI.
 * @return a file monitor service implementation, or {@code null} if no
 * implementation is found
 */
static FileMonitorServiceFactory loadFileMonitorServiceFactory() {
    FileMonitorServiceFactory results = null;
    ServiceLoader&lt;FileMonitorServiceFactory&gt; serviceLoader = ServiceLoader.load(FileMonitorServiceFactory.class);
    Iterator&lt;FileMonitorServiceFactory&gt; implementations = serviceLoader.iterator();
    if (implementations.hasNext()) {
        results = implementations.next();
    }
    return results;
}

/*
 * This method should be called once (and only once), during application
 * start-up.
 */
void startEhCacheOnApplicationLaunch() throws Exception {
   /*
    * Set the name of the sizeof filter file.  This will prevent ehcache
    * warnings about object graphs being too large when it tries to
    * calculate the cache size.
    */
   System.setProperty(&quot;net.sf.ehcache.sizeof.filter&quot;, &quot;ehcachesizeof.filter&quot;);

   /*
    * Replace the groovy script cache defined in ehcache.xml with one that
    * will lazy-load objects from their script files.
    */
   CacheManager defaultCacheManager = CacheManager.getInstance();
   Ehcache scriptCache = defaultCacheManager.getEhcache(&quot;GroovyScripts&quot;);
   SelfPopulatingCache selfPopulatingScriptCache = new SelfPopulatingCache(scriptCache, new GroovyObjectFileLoadingCacheEntryFactory());
   defaultCacheManager.replaceCacheWithDecoratedCache(scriptCache, selfPopulatingScriptCache);

   /*
    * Start the file monitor, which will detect changes to our scripts.
    *
    * Note: This requires an SFMF4J implementation on the class path.
    * Consider setting this up through an IoC container, such as Spring, instead.
    */
    fileMonitorService = loadFileMonitorServiceFactory().createFileMonitorService();
    fileMonitorService.initialize();

   /*
    * Add a listener which will automatically remove an object from the
    * cache when its script file changes, and will stop monitoring for
    * script changes when an object is removed, expired, or evicted from
    * the cache.
    */
   cacheListener = new FileMonitoringCacheEventListener(selfPopulatingScriptCache, fileMonitorService);
   selfPopulatingScriptCache.getCacheEventNotificationService().registerListener(cacheListener);

   /*
    * By default, Ehcache waits until the next &quot;get&quot; call before checking
    * for expiration.  However, as long as a file is in the cache, the file
    * monitor will poll the file system looking for changes to that file, even
    * if the entry has expired (i.e. the next &quot;get&quot; call will cause us to load
    * the script file again).
    *
    * To prevent unnecessary file polling in this case, we start a timer
    * here to periodically ask the cache to evict expired elements.
    */
   ehcacheExpirationMonitorService = Executors.newSingleThreadScheduledExecutor(new ThreadFactory() {
       @Override
       public Thread newThread(Runnable r) {
           return new Thread(r, &quot;Ehcache Expiration Monitor&quot;);
       }
   });
   ehcacheExpirationMonitorService.scheduleWithFixedDelay(new Runnable() {
       @Override
       public void run() {
           Ehcache scriptCache = CacheManager.getInstance().getEhcache(&quot;GroovyScripts&quot;);
           scriptCache.evictExpiredElements();
       }
   }, 0, CACHE_EXPIRATION_MINUTES, TimeUnit.MINUTES);
}
</pre></div></div></div><div class="section"><h3>Application Shutdown<a name="Application_Shutdown"></a></h3><p>Since caching and file monitoring spawn background threads, we have a bit of housekeeping to do when the application is shut down.</p><div class="source"><pre class="prettyprint">/*
 * This method should be called once (and only once), during application
 * shutdown.
 */
void onApplicationShutdown() {
    /*
     * Stop the cache expiration monitoring timer.
     */
    ehcacheExpirationMonitorService.shutdown();

    /*
     * Stop the file system monitor.
     */
    fileMonitorService.shutdown();

    /*
     * Stop Ehcache background threads and allow garbage collection of caches
     * and their contents.
     */
    CacheManager.getInstance().shutdown();
}
</pre></div></div></div>
                  </div>
          </div>

    <hr/>

    <footer>
            <div class="container">
              <div class="row span12">Copyright &copy;                    2013
                        <a href="https://github.com/sworisbreathing/">Steven Swor</a>.
            All Rights Reserved.      
                    
                  <li id="publishDate" class="pull-right">Last Published: 2013-03-06</li> 
            </div>

        
                <p id="poweredBy" class="pull-right">
                          <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
              </p>
        
                </div>
    </footer>
  </body>
</html>
